{% extends "base.html" %}

{% block title %}İzleme - AI-TwitterPersona{% endblock %}

{% block content %}
<div class="row">
    <!-- Current Trending Topics -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-fire"></i> Güncel Trending Konular</h5>
                <button class="btn btn-sm btn-outline-light" onclick="refreshTrends()">
                    <i class="fas fa-sync" id="refresh-icon"></i> Yenile
                </button>
            </div>
            <div class="card-body">
                <div id="trending-topics-container">
                    {% if trends %}
                        <div class="row">
                            {% for trend in trends %}
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between align-items-center p-3 border rounded">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ loop.index }}. {{ trend.split('(')[0].strip() }}</h6>
                                        {% if '(' in trend %}
                                        <small class="text-muted">
                                            <i class="fas fa-chart-line"></i> {{ trend.split('(')[1].split(')')[0] }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="tweetAboutTrend('{{ trend }}')">
                                            <i class="fas fa-paper-plane"></i> Tweet At
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Trending konular yüklenemedi</h5>
                            <button class="btn btn-primary" onclick="refreshTrends()">
                                <i class="fas fa-sync"></i> Tekrar Dene
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Status Grid -->
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plug"></i> API Bağlantı Durumu</h5>
            </div>
            <div class="card-body">
                <div class="row text-center" id="api-status-grid">
                    <div class="col-md-3 col-6 mb-3">
                        <div class="api-status-indicator">
                            <div id="twitter-status" class="status-circle bg-secondary mx-auto mb-2"></div>
                            <h6>Twitter API</h6>
                            <small id="twitter-ping" class="text-muted">Kontrol ediliyor...</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="api-status-indicator">
                            <div id="gemini-status" class="status-circle bg-secondary mx-auto mb-2"></div>
                            <h6>Gemini AI</h6>
                            <small id="gemini-ping" class="text-muted">Kontrol ediliyor...</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="api-status-indicator">
                            <div id="trends-status" class="status-circle bg-secondary mx-auto mb-2"></div>
                            <h6>Trends API</h6>
                            <small id="trends-ping" class="text-muted">Kontrol ediliyor...</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="api-status-indicator">
                            <div id="database-status" class="status-circle bg-secondary mx-auto mb-2"></div>
                            <h6>Database</h6>
                            <small id="database-ping" class="text-muted">Kontrol ediliyor...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Console Output -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-terminal"></i> Gerçek Zamanlı Konsol Çıktısı</h5>
                <div>
                    <button class="btn btn-sm btn-outline-light me-2" onclick="clearConsole()">
                        <i class="fas fa-trash"></i> Temizle
                    </button>
                    <div class="form-check form-switch d-inline-block">
                        <input class="form-check-input" type="checkbox" id="auto-scroll" checked>
                        <label class="form-check-label text-light" for="auto-scroll">Auto-scroll</label>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="console-output" class="bg-dark text-light p-3" style="height: 400px; overflow-y: scroll; font-family: 'Courier New', monospace; font-size: 0.875rem;">
                    <div class="console-line">
                        <span class="text-success">[14:30:15]</span>
                        <span class="text-info">[INFO]</span>
                        AI-TwitterPersona Dashboard başlatıldı
                    </div>
                    <div class="console-line">
                        <span class="text-success">[14:30:16]</span>
                        <span class="text-info">[INFO]</span>
                        Veritabanı bağlantısı kuruldu
                    </div>
                    <div class="console-line">
                        <span class="text-success">[14:30:17]</span>
                        <span class="text-info">[INFO]</span>
                        Twitter API credentials doğrulandı
                    </div>
                    <div class="console-line">
                        <span class="text-success">[14:30:18]</span>
                        <span class="text-warning">[WARN]</span>
                        Bot henüz başlatılmamış
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let consoleLines = [];
    
    // Initialize monitoring
    document.addEventListener('DOMContentLoaded', function() {
        checkAPIStatus(); // Check API status on page load

        // Set up periodic API status checks
        setInterval(checkAPIStatus, 30000); // Check API status every 30 seconds

        // Clear mock data from console
        document.getElementById('console-output').innerHTML = '';
        addConsoleLog('INFO', 'Gerçek zamanlı izleme başlatıldı');
    });
    
    // Check API Status
    function checkAPIStatus() {
        fetch('/api/check_status', {
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateAPIStatusDisplay(data.status);
            }
        })
        .catch(error => {
            console.error('API status check error:', error);
        });
    }

    function updateAPIStatusDisplay(status) {
        // Update Twitter API
        updateSingleAPIStatus('twitter', status.twitter);
        // Update Gemini AI
        updateSingleAPIStatus('gemini', status.gemini);
        // Update Trends API
        updateSingleAPIStatus('trends', status.trends);
        // Update Database
        updateSingleAPIStatus('database', status.database);
    }

    function updateSingleAPIStatus(apiName, apiStatus) {
        const statusElement = document.getElementById(`${apiName}-status`);
        const pingElement = document.getElementById(`${apiName}-ping`);

        if (statusElement && pingElement) {
            // Remove all status classes
            statusElement.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'bg-secondary');

            if (apiStatus.status === 'success') {
                statusElement.classList.add('bg-success');
                pingElement.textContent = apiStatus.ping ? `Ping: ${apiStatus.ping}ms` : 'Bağlı';
            } else if (apiStatus.status === 'warning') {
                statusElement.classList.add('bg-warning');
                pingElement.textContent = apiStatus.message || 'Yavaş';
            } else {
                statusElement.classList.add('bg-danger');
                pingElement.textContent = apiStatus.message || 'Bağlantı yok';
            }
        }
    }

    // Refresh trending topics
    function refreshTrends() {
        const refreshIcon = document.getElementById('refresh-icon');
        const container = document.getElementById('trending-topics-container');
        
        refreshIcon.classList.add('fa-spin');
        container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i><br><small class="text-muted">Trendler yenileniyor...</small></div>';
        
        fetch('/api/trends')
            .then(response => response.json())
            .then(data => {
                if (data.trends && data.trends.length > 0) {
                    let html = '<div class="row">';
                    data.trends.forEach((trend, index) => {
                        html += `
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between align-items-center p-3 border rounded">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">${trend.split('(')[0].trim()}</h6>
                                        ${trend.includes('(') ? `<small class="text-muted"><i class="fas fa-chart-line"></i> ${trend.split('(')[1].split(')')[0]}</small>` : ''}
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-primary" onclick="tweetAboutTrend('${trend}')">
                                            <i class="fas fa-paper-plane"></i> Tweet At
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="text-center py-4"><i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i><h5 class="text-muted">Trend bulunamadı</h5></div>';
                }
            })
            .catch(error => {
                container.innerHTML = '<div class="text-center py-4"><i class="fas fa-times-circle fa-3x text-danger mb-3"></i><h5 class="text-muted">Trendler yüklenemedi</h5></div>';
            })
            .finally(() => {
                refreshIcon.classList.remove('fa-spin');
            });
    }
    
    // Tweet about trend
    function tweetAboutTrend(trend) {
        if (confirm(`"${trend.split('(')[0].trim()}" hakkında tweet atmak istediğinizden emin misiniz?`)) {
            // Redirect to manual tweet page with pre-filled content
            const trendName = trend.split('(')[0].trim();
            window.location.href = `/manual?topic=${encodeURIComponent(trendName)}`;
        }
    }
    
    // Listen to real WebSocket console logs
    if (typeof socket !== 'undefined') {
        // Listen for console log events from the server
        socket.on('console_log', function(data) {
            addConsoleLog(data.type, data.message, data.timestamp);
        });

        // Listen for bot status changes
        socket.on('bot_status', function(data) {
            if (data.message) {
                addConsoleLog('INFO', data.message);
            }
        });

        // Listen for new tweet events
        socket.on('new_tweet', function(data) {
            const status = data.status ? 'SUCCESS' : 'ERROR';
            const message = data.status
                ? `Tweet gönderildi: ${data.tweet.substring(0, 50)}...`
                : `Tweet gönderilemedi: ${data.error}`;
            addConsoleLog(status, message);
        });
    }
    
    function addConsoleLog(type, message, timestamp = null) {
        if (!timestamp) {
            timestamp = new Date().toLocaleTimeString();
        }
        
        const typeColors = {
            'INFO': 'text-info',
            'WARN': 'text-warning', 
            'ERROR': 'text-danger',
            'SUCCESS': 'text-success'
        };
        
        const consoleOutput = document.getElementById('console-output');
        const newLine = document.createElement('div');
        newLine.className = 'console-line';
        newLine.innerHTML = `
            <span class="text-success">[${timestamp}]</span> 
            <span class="${typeColors[type]}">[${type}]</span> 
            ${message}
        `;
        
        consoleOutput.appendChild(newLine);
        
        // Auto-scroll if enabled
        if (document.getElementById('auto-scroll').checked) {
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // Limit console lines to 100
        const lines = consoleOutput.querySelectorAll('.console-line');
        if (lines.length > 100) {
            lines[0].remove();
        }
    }
    
    function clearConsole() {
        document.getElementById('console-output').innerHTML = '';
        addConsoleLog('INFO', 'Konsol temizlendi');
    }
    
</script>

<style>
    .status-circle {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .api-status-indicator {
        text-align: center;
    }
    
    .console-line {
        margin-bottom: 2px;
        font-size: 0.8rem;
    }
    
    #console-output::-webkit-scrollbar {
        width: 8px;
    }
    
    #console-output::-webkit-scrollbar-track {
        background: #2c3e50;
    }
    
    #console-output::-webkit-scrollbar-thumb {
        background: #5a6c7d;
        border-radius: 4px;
    }
</style>
{% endblock %}