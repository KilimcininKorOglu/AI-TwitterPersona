{% extends "base.html" %} {% block title %}Anasayfa - AI-TwitterPersona{%
endblock %} {% block content %}
<div class="row">
  <!-- Bot Status Card -->
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-robot"></i> Bot İşlemleri</h5>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6>Durum:</h6>
            {% if bot_running %}
            <span class="badge bg-success fs-6">
              <i class="fas fa-play"></i> Çalışıyor
            </span>
            {% else %}
            <span class="badge bg-danger fs-6">
              <i class="fas fa-stop"></i> Durduruldu
            </span>
            {% endif %}
          </div>
          <div>
            {% if bot_running %}
            <button class="btn btn-outline-danger" onclick="controlBot('stop')">
              <i class="fas fa-stop"></i> Durdur
            </button>
            {% else %}
            <button class="btn btn-outline-success" onclick="controlBot('start')">
              <i class="fas fa-play"></i> Başlat
            </button>
            {% endif %}
          </div>
        </div>

        {% if stats.bot_start_time %}
        <hr />
        <small class="text-muted">
          <i class="fas fa-clock"></i> Başlatılma: {{ stats.bot_start_time }}
        </small>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Tweet Statistics Card -->
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-chart-bar"></i> Tweet İstatistikleri</h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-4">
            <h4 class="text-primary">{{ stats.daily_tweets }}</h4>
            <small>Bugün</small>
          </div>
          <div class="col-4">
            <h4 class="text-info">{{ stats.total_tweets }}</h4>
            <small>Toplam</small>
          </div>
          <div class="col-4">
            <h4 class="text-success" id="countdown-container">
              <span id="next-tweet-countdown">--:--</span>
            </h4>
            <small>Sonraki Tweet</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Last Tweet Card -->
{% if stats.last_tweet %}
<div class="row">
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-comment"></i> Son Tweet</h5>
      </div>
      <div class="card-body">
        <blockquote class="blockquote">
          <p>"{{ stats.last_tweet }}"</p>
          <footer class="blockquote-footer">
            <i class="fas fa-clock"></i> {{ stats.last_tweet_time }}
          </footer>
        </blockquote>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-bolt"></i> Hızlı İşlemler</h5>
      </div>
      <div class="card-body">
        <div class="btn-group" role="group">
          <button class="btn btn-outline-danger" onclick="emergencyStop()">
            <i class="fas fa-stop-circle"></i> ACİL DURDUR
          </button>
          <button class="btn btn-outline-warning" onclick="clearDatabase()">
            <i class="fas fa-database"></i> Veritabanını Temizle
          </button>
          <button class="btn btn-outline-info" onclick="exportData()">
            <i class="fas fa-download"></i> Veri Dışa Aktar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // Socket is already initialized in app.js, no need to re-initialize

  // Listen for additional bot status updates if needed
  if (typeof socket !== 'undefined') {
    socket.on('dashboard_update', function(data) {
      console.log('Dashboard update:', data);
      updateBotUI(data.running);
    });

    // Listen for bot started event to reset countdown
    socket.on('bot_status', function(data) {
      if (data.running && data.message && data.message.includes('başlatıldı')) {
        resetCountdown();
      }
    });

    // Listen for new tweet event to reset countdown
    socket.on('new_tweet', function(data) {
      resetCountdown();
    });
  }

  // Countdown timer variables
  let dashboardCountdownInterval;
  let nextTweetTime;
  const CYCLE_DURATION = {{ config.cycle_duration | default(30) }}; // Minutes from config

  // Initialize countdown on page load
  initializeCountdown();

  // Real-time updates
  setInterval(updateStatus, 10000); // Update every 10 seconds

  function updateStatus() {
    fetch("/api/status")
      .then((response) => response.json())
      .then((data) => {
        // Update UI based on status
        updateBotUI(data.running);
      })
      .catch((error) => {
        console.error("Status update error:", error);
      });
  }

  function updateBotUI(isRunning) {
    // Update status badge
    const statusBadge = document.querySelector('.card-body .badge');
    if (statusBadge) {
      if (isRunning) {
        statusBadge.className = 'badge bg-success fs-6';
        statusBadge.innerHTML = '<i class="fas fa-play"></i> Çalışıyor';
      } else {
        statusBadge.className = 'badge bg-danger fs-6';
        statusBadge.innerHTML = '<i class="fas fa-stop"></i> Durduruldu';
      }
    }

    // Update control button
    const controlButtons = document.querySelectorAll('button[onclick*="controlBot"]');
    controlButtons.forEach(button => {
      if (isRunning) {
        button.className = 'btn btn-outline-danger';
        button.innerHTML = '<i class="fas fa-stop"></i> Durdur';
        button.onclick = () => controlBot('stop');
      } else {
        button.className = 'btn btn-outline-success';
        button.innerHTML = '<i class="fas fa-play"></i> Başlat';
        button.onclick = () => controlBot('start');
      }
    });

    // Update bot start time visibility
    const startTimeElement = document.querySelector('.text-muted');
    if (startTimeElement && startTimeElement.textContent.includes('Başlatılma:')) {
      if (!isRunning) {
        // Hide start time and separator when bot is stopped
        startTimeElement.style.display = 'none';
        const separator = startTimeElement.previousElementSibling;
        if (separator && separator.tagName === 'HR') {
          separator.style.display = 'none';
        }
      } else {
        // Show start time when bot is running
        startTimeElement.style.display = 'block';
        const separator = startTimeElement.previousElementSibling;
        if (separator && separator.tagName === 'HR') {
          separator.style.display = 'block';
        }
      }
    }
  }

  function controlBot(action) {
    // Disable button to prevent duplicate clicks
    const buttons = document.querySelectorAll('button[onclick*="controlBot"]');
    buttons.forEach(btn => btn.disabled = true);

    fetch("/api/control", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document
          .querySelector('meta[name="csrf-token"]')
          .getAttribute("content"),
      },
      body: JSON.stringify({ action: action }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Show success message
          console.log(data.message);

          // Update UI immediately (WebSocket will also update)
          updateBotUI(action === 'start');

          // Show notification instead of alert
          const notification = document.createElement('div');
          notification.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
          notification.style.zIndex = '9999';
          notification.innerHTML = `
            ${data.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.body.appendChild(notification);

          // Auto-dismiss after 3 seconds
          setTimeout(() => {
            notification.remove();
          }, 3000);
        } else {
          // Show error
          alert("Hata: " + data.message);
        }
      })
      .catch((error) => {
        console.error("Bot control error:", error);
        alert("Bot kontrolünde hata oluştu");
      })
      .finally(() => {
        // Re-enable buttons
        buttons.forEach(btn => btn.disabled = false);
      });
  }

  function refreshTrends() {
    alert("Trendler yenileniyor...");
    // Implementation for trend refresh
  }

  function forceTweet() {
    if (confirm("Hemen tweet atmak istediğinizden emin misiniz?")) {
      const button = event.target;
      const originalText = button.innerHTML;

      button.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> Gönderiliyor...';
      button.disabled = true;

      fetch("/api/force_tweet", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document
            .querySelector('meta[name="csrf-token"]')
            .getAttribute("content"),
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert("Tweet başarıyla gönderildi!\n\n" + data.tweet);
          } else {
            alert("Tweet gönderilemedi: " + data.message);
          }
        })
        .catch((error) => {
          alert("Hata oluştu: " + error.message);
        })
        .finally(() => {
          button.innerHTML = originalText;
          button.disabled = false;
        });
    }
  }

  function emergencyStop() {
    if (
      confirm(
        "ACİL DURDURMA yapılacak! Tüm bot işlemleri durdurulacak. Emin misiniz?"
      )
    ) {
      fetch("/api/emergency_stop", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document
            .querySelector('meta[name="csrf-token"]')
            .getAttribute("content"),
        },
      })
        .then((response) => response.json())
        .then((data) => {
          alert(data.message);
          location.reload();
        })
        .catch((error) => {
          alert("Acil durdurma hatası: " + error.message);
        });
    }
  }

  function clearDatabase() {
    if (
      confirm(
        "Tüm tweet veritabanını temizlemek istediğinizden emin misiniz? Bu işlem GERİ ALINAMAZ!"
      )
    ) {
      if (
        confirm("SON UYARI: Tüm tweet geçmişi silinecek. Devam edilsin mi?")
      ) {
        fetch("/api/clear_database", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document
              .querySelector('meta[name="csrf-token"]')
              .getAttribute("content"),
          },
        })
          .then((response) => response.json())
          .then((data) => {
            alert(data.message);
            location.reload();
          })
          .catch((error) => {
            alert("Veritabanı temizleme hatası: " + error.message);
          });
      }
    }
  }

  function exportData() {
    alert("Veri dışa aktarma özelliği gelecek güncellemede eklenecek.");
  }

  // Countdown Timer Functions
  function initializeCountdown() {
    // Get last tweet time from localStorage or use current time
    const lastTweetTime = localStorage.getItem('lastTweetTime');

    if (lastTweetTime) {
      const lastTime = new Date(parseInt(lastTweetTime));
      const nextTime = new Date(lastTime.getTime() + (CYCLE_DURATION * 60 * 1000));

      // Check if next time is in the future
      if (nextTime > new Date()) {
        nextTweetTime = nextTime;
      } else {
        // If past, calculate next interval from now
        resetCountdown();
      }
    } else {
      // No last tweet time, assume bot just started
      resetCountdown();
    }

    // Start the countdown
    startCountdown();
  }

  function resetCountdown() {
    // Set next tweet time to CYCLE_DURATION minutes from now
    nextTweetTime = new Date(Date.now() + (CYCLE_DURATION * 60 * 1000));
    localStorage.setItem('lastTweetTime', Date.now().toString());
  }

  function startCountdown() {
    // Clear any existing interval
    if (dashboardCountdownInterval) {
      clearInterval(dashboardCountdownInterval);
    }

    // Update immediately
    updateCountdownDisplay();

    // Update every second
    dashboardCountdownInterval = setInterval(updateCountdownDisplay, 1000);
  }

  function updateCountdownDisplay() {
    if (!nextTweetTime) {
      document.getElementById('next-tweet-countdown').textContent = '--:--';
      return;
    }

    const now = new Date();
    const diff = nextTweetTime - now;

    if (diff <= 0) {
      // Time's up, reset countdown
      document.getElementById('next-tweet-countdown').textContent = 'Şimdi!';

      // Reset after a moment
      setTimeout(() => {
        resetCountdown();
        startCountdown();
      }, 2000);

      return;
    }

    // Calculate minutes and seconds
    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);

    // Format as MM:SS
    const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('next-tweet-countdown').textContent = display;

    // Change color based on remaining time
    const countdownContainer = document.getElementById('countdown-container');
    if (minutes < 1) {
      countdownContainer.className = 'text-danger'; // Red when less than 1 minute
    } else if (minutes < 5) {
      countdownContainer.className = 'text-warning'; // Yellow when less than 5 minutes
    } else {
      countdownContainer.className = 'text-success'; // Green otherwise
    }
  }

  // Clean up on page unload
  window.addEventListener('beforeunload', function() {
    if (dashboardCountdownInterval) {
      clearInterval(dashboardCountdownInterval);
    }
  });
</script>
{% endblock %}
